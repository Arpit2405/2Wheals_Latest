@{
    ViewBag.Title = "Menu Tree Management";
    Layout = "~/Views/Shared/_Admin_Layout.cshtml";
}

@model List<test2wheelers.Models.RoleMenuPermissionModel>

<style>
    .toggle {
        cursor: pointer;
        margin-right: 5px;
        color: #007bff;
    }
</style>

<ol class="breadcrumb mb-0">
    <li class="breadcrumb-item">
        <a href="/"><i class="fas fa-home"></i> Home</a>
    </li>
    <li class="breadcrumb-item active"> Menu </li>
</ol>


<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <h2 class="mb-4"><i class="fas fa-bars"></i> Menu Tree</h2>

                <!-- Add Root Menu Button -->
                <div class="mb-3 text-right">
                    <button type="button" class="btn btn-success btn-sm px-3"
                            data-bs-toggle="modal"
                            data-bs-target="#menuModal"
                            onclick="openAddRootMenu()">
                        <i class="fa fa-plus"></i> Add Root Menu
                    </button>
                </div>

                <!-- Add Modal -->
                <div class="modal fade" id="menuModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered" role="document">
                        <div class="modal-content  shadow-lg rounded-lg">
                            <form id="menuForm">
                                <div class="modal-header bg-success text-white">
                                    <h5 class="modal-title" id="addBrandsModalLabel">Add Menu</h5>
                                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">×</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <input type="hidden" id="MenuId" name="MenuId" value="0" />
                                    <input type="hidden" id="ParentMenuId" name="ParentMenuId" value="" />

                                    <div class="mb-3">
                                        <label for="MenuName" class="form-label">Menu Name</label>
                                        <input type="text" class="form-control" id="MenuName" name="MenuName" required />
                                    </div>

                                    <div class="mb-3">
                                        <label for="Url" class="form-label">Url</label>
                                        <input type="text" class="form-control" id="Url" name="Url" />
                                    </div>

                                    <div class="mb-3">
                                        <label for="Url" class="form-label">Icon</label>
                                        <input type="text" class="form-control" id="Icon" name="Icon" required />
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fa fa-save"></i> Save
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Edit Modal -->
                <div class="modal fade" id="editMenuModal" tabindex="-1" role="dialog" aria-labelledby="editMenuModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Edit Menu</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <input type="hidden" id="editMenuId" />
                                <div class="form-group">
                                    <label>Menu Name</label>
                                    <input type="text" id="editMenuName" class="form-control" />
                                </div>
                                <div class="form-group mt-2">
                                    <label>URL</label>
                                    <input type="text" id="editMenuUrl" class="form-control" />
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" id="saveEditMenu">Save</button>
                            </div>
                        </div>
                    </div>
                </div>

                <ul id="menuTree" class="sortable list-unstyled">
                    @foreach (var menu in Model.Where(m => m.ParentMenuId == null))
                    {
                        <li data-id="@menu.MenuId" class="mb-2">
                            <span class="toggle" data-target="#children-@menu.MenuId">  📂</span>
                            <span class="fw-bold">@menu.MenuName</span>


                            <!-- Action buttons for root -->
                            <a href="javascript:void(0);" class="text-success ms-2"
                               data-bs-toggle="modal"
                               data-bs-target="#menuModal"
                               data-parentid="@menu.MenuId">
                                <i class="fas fa-plus-circle"></i>
                            </a>

                            <a href="javascript:void(0);"
                               class="edit-menu text-warning"
                               data-id="@menu.MenuId"
                               data-name="@menu.MenuName"
                               data-url="@menu.Url">
                                <i class="fas fa-pencil-alt"></i>
                            </a>
                            <a href="javascript:void(0);" class="delete-menu text-danger ms-2"
                               data-id="@menu.MenuId" title="Delete">
                                <i class="fas  fa-trash"></i>
                            </a>

                            @if (menu.Children?.Any() == true)
                            {
                                <ul id="children-@menu.MenuId" class="collapse ms-4">
                                    @foreach (var child in menu.Children)
                                    {
                                        @Html.Partial("_TreeNodePartial", child)
                                    }
                                </ul>
                            }
                        </li>
                    }
                </ul>

                <button id="saveTree" class="btn btn-success btn-sm px-3">Save Order</button>
            </div>
        </div>
    </div>
</div>



@section Scripts {
    <script>

        $(document).on("click", ".edit-menu", function () {
            let id = $(this).data("id");
            let name = $(this).data("name");
            let url = $(this).data("url");

            $("#editMenuId").val(id);
            $("#editMenuName").val(name);
            $("#editMenuUrl").val(url);

            $("#editMenuModal").modal("show");
        });

        $("#saveEditMenu").click(function () {
            let menuModel = {
                MenuId: parseInt($("#editMenuId").val()), // force number
                MenuName: $("#editMenuName").val(),
                Url: $("#editMenuUrl").val()
            };

            $.ajax({
                url: '/Menu/Edit',
                type: 'POST',
                contentType: 'application/json', // ✅ must be JSON
                data: JSON.stringify(menuModel),
                success: function (res) {
                    $("#editMenuModal").modal("hide");
                    location.reload(); // 🔄 reload tree
                },
                error: function () {
                    alert("Error: " + xhr.responseText);
                }
            });
        });

        $(function () {

            // Delete click
            $(document).on("click", ".delete-menu", function () {
                var menuId = $(this).data("id");

                if (confirm("Are you sure you want to delete this menu?")) {
                    $.ajax({
                        url: '/Menu/Delete',   // adjust to your controller
                        type: 'POST',
                        data: { id: menuId },
                        success: function (res) {
                            if (res.success) {
                                // remove the <li> from DOM
                                $("li[data-id='" + menuId + "']").remove();
                            } else {
                                alert("Delete failed: " + res.message);
                            }
                        },
                        error: function () {
                            alert("Error while deleting.");
                        }
                    });
                }
            });

            $(".toggle").on("click", function () {
                var target = $(this).data("target");
                $(target).slideToggle(200); // smooth expand/collapse
            });

            // make tree sortable
            $(".sortable").sortable({
                connectWith: ".sortable",
                placeholder: "ui-state-highlight",
                items: "> li",
                update: function (event, ui) {
                    // auto-save could be triggered here
                }
            }).disableSelection();

            // Save order
            $("#saveTree").click(function () {
                let hierarchy = getHierarchy($("#menuTree > li"));
                $.ajax({
                    url: '@Url.Action("SaveTree", "Menu")',
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(hierarchy),
                    success: function () {
                        alert("Tree saved successfully!");
                    }
                });
            });

            // build hierarchy object
            function getHierarchy($listItems) {
                let result = [];
                $listItems.each(function (index) {
                    let $li = $(this);
                    let node = {
                        MenuId: $li.data("id"),
                        Order: index,
                        Children: getHierarchy($li.children("ul").children("li"))
                    };
                    result.push(node);
                });
                return result;
            }
        });

        function openAddRootMenu() {
            $("#MenuId").val(0);                // new menu
            $("#ParentMenuId").val("");         // root menu
            $("#MenuName").val("");             // clear input
            $(".modal-title").text("Add Root Menu");
            $("#menuModal").modal('show');
        }

        $("#menuForm").submit(function (e) {
            e.preventDefault();

            $.ajax({
                url: '/Menu/SaveMenu',   // controller action
                type: 'POST',
                data: $(this).serialize(),
                success: function (menu) {
                    // Close modal
                    $("#menuModal").modal('hide');

                    // Append new root menu to tree
                    $("#menuTree").append(`
                <li data-id="${menu.menuId}">
                    ${menu.menuName}
                    <a href="javascript:void(0);" class="text-success ms-2 add-node" data-parent="${menu.menuId}" title="Add Child">
                        <i class="fas fa-plus-circle"></i>
                    </a>
                    <a href="javascript:void(0);"
               class="edit-menu text-warning"
               data-id="${menu.menuId}"
               data-name="${menu.menuName}"
               data-url="${menu.Url}"">
                        <i class="fas fa-pencil-alt"></i>
                    </a>
                    <a href="javascript:void(0);" class="delete-menu text-danger ms-2"
               data-id="${menu.menuId}" title="Delete">
                         <i class="fas  fa-trash"></i>
                    </a>
                </li>
            `);
                }
            });
        });

    </script>
}