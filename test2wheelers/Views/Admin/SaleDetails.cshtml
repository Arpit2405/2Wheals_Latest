@model _2whealers.Models.TransactionViewModel
@{
    ViewBag.Title = "Delivery Challan";
    Layout = "~/Views/Shared/_Admin_Layout.cshtml";
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link href="~/css/pre-sale.css" rel="stylesheet" />


<div class="challan-wrapper">
    <div class="text-center mb-3">
        <img src="~/AdminAssets/dist/img/logo1.png" alt="Bike Nation Logo" class="challan-logo" />
        <h2 class="company-name">Bike Nation Motors Pvt. Ltd.</h2>
        <p class="company-address">Near HDFC Bank, Main Bawana Road, Samaypur, Delhi-42</p>
        <h3 class="challan-title">Delivery Challan</h3>
    </div>

    <!-- Table -->
    <table class="table table-bordered">
        <tbody>
            <tr>
                <th>Order ID</th>
                <td>@Model.Id</td>
            </tr>
            <tr>
                <th>Order Date</th>
                <td>@Model.CreatedDate.ToString("dd-MM-yyyy")</td>
            </tr>
            <tr>
                <th>Owner Details</th>
                <td>@Model.Name @Model.Address1 @Model.Address2</td>
            </tr>
            <tr>
                <th>Contact Number</th>
                <td><a href="tel:@Model.MobileNo">@Model.MobileNo</a></td>
            </tr>
            <tr>
                <th>Model Name</th>
                <td>@Model.ModelName</td>
            </tr>
            <tr>
                <th>Vehicle Details</th>
                <td>@Model.VehicleDetails</td>
            </tr>

            <tr>
                <th>Registration Number</th>
                <td>
                    @if (Model.RegNo == "A/F")
                    {
                        <small class="text-muted d-block mb-1">
                            Registration Number can be edited only once if it is "A/F".
                        </small>
                    }

                    <div id="regno-view">
                        <span id="regno-text">@Model.RegNo</span>
                        @if (Model.RegNo == "A/F")
                        {
                            <button class="btn btn-sm btn-primary" id="edit-regno">Edit</button>
                        }
                    </div>

                    <div id="regno-edit" style="display:none;">
                        <input type="text" id="regno-input" class="form-control d-inline-block" style="width:200px;" value="@Model.RegNo" />
                        <button class="btn btn-sm btn-success" id="save-regno">Save</button>
                        <button class="btn btn-sm btn-secondary" id="cancel-regno">Cancel</button>
                    </div>
                </td>
            </tr>




            <tr>
                <th>Engine Number</th>
                <td>@Model.EngineNo</td>
            </tr>
            <tr>
                <th>Chassis Number</th>
                <td>@Model.ChassisNo</td>
            </tr>
            <tr>
                <th>Mileage</th>
                <td>@Model.DRM</td>
            </tr>
            <tr>
                <th>Jobs Done</th>
                <td>Sale</td>
            </tr>
            <tr>
                <th>Amount (Rs.)</th>
                <td>0 /-</td>
            </tr>
            <tr>
                <th>Finance Details</th>
                <td>Financed By:- @Model.FinancedBy <br /> Downpayment:- @Model.Downpayment<br /> Monthly EMI:@Model.CashAmount<br /> Installments: @Model.NoOfInstallments  </td>
            </tr>
            <tr>
                <th>Service Reminder Date</th>
                <td>@Model.DateOfSaleReminder.Value.ToString("dd-MM-yyyy")</td>
            </tr>


        </tbody>
    </table>

    <div class="signature-row">
        <div class="signature-left">
            <div class="signature-box"></div>
            <p>(Customer Signature)</p>
        </div>
        <div class="signature-right">
            <div class="signature-box"></div>
            <p>(Authorized Signature)</p>
        </div>
    </div>

    <div class="text-center no-print">
        <button onclick="window.print()" class="print-btn">
            <i class="bi bi-printer"></i> Print
        </button>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Edit click → textbox dikhao
            $("#edit-regno").click(function () {
                $("#regno-view").hide();
                $("#regno-edit").show();
            });

            // Cancel click → wapas label dikhao
            $("#cancel-regno").click(function () {
                $("#regno-edit").hide();
                $("#regno-view").show();
            });

            // Save click → DB update
            $("#save-regno").click(function () {
                var newRegNo = $("#regno-input").val();
                var id = @Model.Id;

                       if (newRegNo === "") {
                        toastr.error("Registration Number is required");
                        return;
                        }

                    if (newRegNo.length > 20) {
                        toastr.error("Registration No cannot exceed 20 characters.");
                        return;
                    }


                    var regExp = /^[A-Za-z]{2}[0-9]{1,2}[A-Za-z]{1,3}[0-9]{1,4}$/;
                    if (!regExp.test(newRegNo)) {
                        toastr.error("Enter valid Registration No (e.g. MH12AB1234 or DL2CAE3422)");
                        return;
                    }


                $.ajax({
                    url: '@Url.Action("UpdateRegNo", "Admin")',
                    type: 'POST',
                    data: { id: id, regNo: newRegNo },
                    success: function (res) {
                        if (res.success) {
                            toastr.success("Registration Number updated successfully");
                            $("#regno-text").text(res.regNo);
                            $("#regno-edit").hide();
                            $("#regno-view").show();
                            $("#edit-regno").remove();
                        } else {
                            toastr.error(res.message || "Error updating record");
                        }
                    },
                    error: function () {
                        toastr.error("Something went wrong");
                    }
                });
            });
        });
    </script>
}
